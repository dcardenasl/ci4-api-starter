# File Management

The CI4 API Starter provides a robust, stream-based file management system that supports both traditional web uploads and modern JSON-based API interactions.

## Key Features

- **Dual-Mode Uploads**: Automatically detects and handles both `multipart/form-data` and Base64 encoded strings in JSON payloads.
- **Stream-Based Processing**: Large files are processed using PHP streams to keep memory usage low, even for high-concurrency environments.
- **Storage Abstraction**: Seamlessly switch between Local and AWS S3 storage via configuration.
- **Smart Sanitization**: Aggressively cleans filenames to remove temporary prefixes and handles name collisions with numeric series.

---

## Uploading Files

The `POST /api/v1/files` endpoint is highly flexible. It expects a file in one of the following formats:

### 1. Multipart Form Data (Standard)
Ideal for web forms or mobile apps using standard upload libraries.
- **Field Name**: `file`
- **Content-Type**: `multipart/form-data`

### 2. Base64 (JSON)
Ideal for clients that prefer sending everything in a single JSON body. The system detects Base64 strings automatically if they are in the `file` field or if a string is exceptionally long.

**Format A: Data URI (Recommended)**
```json
{
  "file": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg=="
}
```

**Format B: Raw Base64**
If sending raw base64 without the `data:` prefix, you should provide metadata:
```json
{
  "file": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==",
  "mime_type": "image/png",
  "filename": "pixel.png"
}
```

---

## Filename Sanitization & Collisions

To ensure a clean storage structure, the system performs several operations on the filename:

1. **Prefix Removal**: Removes temporary hashes generated by some clients (e.g., `upload_65da..._myphoto.jpg` becomes `myphoto.jpg`).
2. **Character Cleaning**: Only alphanumeric characters, dashes, and underscores are allowed.
3. **Collision Handling**: If `photo.jpg` already exists, the system automatically tries `photo_1.jpg`, `photo_2.jpg`, etc., up to 20 attempts before appending a unique ID.

## Performance & Streaming

Unlike standard implementations that read the entire file into memory (especially Base64 decodes), this starter:
1. Decodes Base64 directly into a `php://temp` stream.
2. Passes the stream resource to the storage driver.
3. Ensures memory usage remains constant regardless of file size (within the limits of `FILE_MAX_SIZE`).

## Configuration

Control file behavior via `.env`:

```env
# Max size in bytes (e.g., 20MB)
FILE_MAX_SIZE=20971520
# Allowed extensions
FILE_ALLOWED_TYPES=jpg,jpeg,png,gif,pdf
# Storage driver (local or s3)
STORAGE_DRIVER=local
```
